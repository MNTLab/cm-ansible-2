---
# tasks file for jenkins
- name: check Java version
  shell: java -version 2>&1 | grep version | awk '{print $3}' | sed 's/"//g' | sed 's/....$//'
  register: java_version_installed

- include: roles/java/tasks/main.yml
  when: java_version_installed.stdout != java_version

- name: Install Git
  yum: name=git state=latest

- name: Import Jenkins repo key
  rpm_key:
   key: https://jenkins-ci.org/redhat/jenkins-ci.org.key
   state: present
   validate_certs: no

- name: Get jenkins repo
  get_url:
   url: http://pkg.jenkins-ci.org/redhat/jenkins.repo
   dest: /etc/yum.repos.d/jenkins.repo

- name: Install Jenkins
  yum: name=jenkins state=latest


- name: Copy Jenkins configuration files
  template: src={{ item.filename }} dest={{ item.dest }} force=no owner=jenkins group=jenkins mode=0644
  with_items:    
    - {filename: 'templates/hudson.tasks.Maven.xml',dest: '/var/lib/jenkins/'}
    - {filename: 'templates/config.xml', dest: '/var/lib/jenkins/config.xml'}
    - {filename: 'templates/jenkins', dest: '/etc/sysconfig/jenkins', mode: "0600", owner: "root", group: "root"}
  notify:
   - restart jenkins

- name: Copy Jenkins Jobs and plugins
  copy: src={{ item.filename }} dest={{ item.dest }} force=no owner=jenkins group=jenkins
  with_items:
    - {filename: 'templates/plugins', dest: '/var/lib/jenkins/'}
    - {filename: 'templates/jobs', dest: '/var/lib/jenkins/'}
  notify:
   - restart jenkins

- name: Start jenkins
  service: name=jenkins state=started
